

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Haoyu Chai">
  <meta name="keywords" content="">
  
    <meta name="description" content="CA端四步走第一步：初始化环境1res &#x3D; TEEC_InitializeContext(NULL, &amp;ctx);  这句话在整个 OP-TEE 的流程中是 “万里长征第一步”。如果这步失败了，后面的所有操作（找 TA、发指令）全都会报错。 我们可以从三个维度来理解它：比喻维度、语法维度、底层维度。  1. 比喻维度：走进银行大门 动作：这行代码相当于你推开了银行的大门，站在了大堂里。">
<meta property="og:type" content="article">
<meta property="og:title" content="CA快速入门">
<meta property="og:url" content="https://jakechender.github.io/2025/11/25/1%E3%80%81CA%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="HY-Chai的主页">
<meta property="og:description" content="CA端四步走第一步：初始化环境1res &#x3D; TEEC_InitializeContext(NULL, &amp;ctx);  这句话在整个 OP-TEE 的流程中是 “万里长征第一步”。如果这步失败了，后面的所有操作（找 TA、发指令）全都会报错。 我们可以从三个维度来理解它：比喻维度、语法维度、底层维度。  1. 比喻维度：走进银行大门 动作：这行代码相当于你推开了银行的大门，站在了大堂里。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jakechender.github.io/img/bg2.WEBP">
<meta property="article:published_time" content="2025-11-25T10:48:00.000Z">
<meta property="article:modified_time" content="2025-11-25T10:49:13.218Z">
<meta property="article:author" content="Haoyu Chai">
<meta property="article:tag" content="OPTEE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jakechender.github.io/img/bg2.WEBP">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CA快速入门 - HY-Chai的主页</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jakechender.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":100,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>HY-Chai</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg2.WEBP') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CA快速入门"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Haoyu Chai
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-25 18:48" pubdate>
          2025年11月25日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          25 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CA快速入门</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="CA端四步走"><a href="#CA端四步走" class="headerlink" title="CA端四步走"></a><strong>CA端四步走</strong></h2><h3 id="第一步：初始化环境"><a href="#第一步：初始化环境" class="headerlink" title="第一步：初始化环境"></a><strong>第一步：初始化环境</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">res = TEEC_InitializeContext(<span class="hljs-literal">NULL</span>, &amp;ctx);<br></code></pre></td></tr></table></figure>

<p>这句话在整个 OP-TEE 的流程中是 <strong>“万里长征第一步”</strong>。如果这步失败了，后面的所有操作（找 TA、发指令）全都会报错。</p>
<p>我们可以从三个维度来理解它：<strong>比喻维度</strong>、<strong>语法维度</strong>、<strong>底层维度</strong>。</p>
<hr>
<h3 id="1-比喻维度：走进银行大门"><a href="#1-比喻维度：走进银行大门" class="headerlink" title="1. 比喻维度：走进银行大门"></a>1. 比喻维度：走进银行大门</h3><ul>
<li><p><strong>动作</strong>：这行代码相当于你<strong>推开了银行的大门，站在了大堂里</strong>。</p>
</li>
<li><p><strong>状态</strong>：你还没有去具体的柜台（还没找 Session），你只是进入了“可以办理业务”的环境。</p>
</li>
<li><p><strong>结果</strong>：如果你成功进去了，银行大堂经理会发给你一张 <strong>“临时通行证”</strong>（也就是填好了的 <code>ctx</code> 变量）。以后你在银行里的所有活动，都要带着这张证。</p>
</li>
</ul>
<hr>
<h3 id="2-语法维度：参数拆解"><a href="#2-语法维度：参数拆解" class="headerlink" title="2. 语法维度：参数拆解"></a>2. 语法维度：参数拆解</h3><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">TEEC_Result <span class="hljs-title function_">TEEC_InitializeContext</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, TEEC_Context *context)</span>;<br></code></pre></td></tr></table></figure>

<p>我们来看看你传入的两个参数分别是什么意思：</p>
<h4 id="参数-1-NULL-name"><a href="#参数-1-NULL-name" class="headerlink" title="参数 1: NULL (name)"></a>参数 1: <code>NULL</code> (name)</h4><ul>
<li><p><strong>字面意思</strong>：名字。</p>
</li>
<li><p><strong>实际含义</strong>：你要连接哪一个 TEE OS？</p>
</li>
<li><p><strong>为什么填 NULL？</strong></p>
<ul>
<li><p>大多数嵌入式设备上（比如你的开发板或 QEMU），只有一个 TEE 环境（也就是 OP-TEE）。</p>
</li>
<li><p>填 <code>NULL</code> 的意思就是：“<strong>我不挑，就连那个默认的 TEE。</strong>”</p>
</li>
<li><p><em>注：极少数复杂的系统可能有多个 TEE，那时才需要填具体的名字，比如 “OP-TEE” 或 “Trusty”，但在 99% 的情况下，这里都是 NULL。</em></p>
</li>
</ul>
</li>
</ul>
<h4 id="参数-2-ctx-context"><a href="#参数-2-ctx-context" class="headerlink" title="参数 2: &amp;ctx (context)"></a>参数 2: <code>&amp;ctx</code> (context)</h4><ul>
<li><p><strong>字面意思</strong>：上下文（Context）的地址。</p>
</li>
<li><p><strong>实际含义</strong>：这是一个 <strong>“传出参数”</strong>（Output Parameter）。</p>
<ul>
<li><p>在调用函数前，<code>ctx</code> 是一个空的结构体，里面全是 0 或垃圾数据。类型是TEEC_Context</p>
</li>
<li><p>你把 <code>ctx</code> 的内存地址（<code>&amp;ctx</code>）告诉函数。</p>
</li>
<li><p>函数执行成功后，OP-TEE 的库（libteec）会把连接的底层细节（比如文件描述符）<strong>填写</strong>到这个结构体里。</p>
</li>
<li><p><strong>重点</strong>：这一步之后，<code>ctx</code> 就是那个 <strong>“通行证”</strong> 了，绝对不能丢，也不能随便改。</p>
</li>
</ul>
</li>
</ul>
<h4 id="返回值-res-result"><a href="#返回值-res-result" class="headerlink" title="返回值: res (result)"></a>返回值: <code>res</code> (result)</h4><ul>
<li><p>如果成功，<code>res</code> 会等于 <code>TEEC_SUCCESS</code> (0)。</p>
</li>
<li><p>如果失败（比如驱动没加载），它会返回一个非 0 的错误码。</p>
</li>
</ul>
<hr>
<h3 id="3-底层维度：到底发生了什么？（进阶理解）"><a href="#3-底层维度：到底发生了什么？（进阶理解）" class="headerlink" title="3. 底层维度：到底发生了什么？（进阶理解）"></a>3. 底层维度：到底发生了什么？（进阶理解）</h3><p>既然你在做复现，了解一点底层原理会让你对系统的理解更上一层楼。</p>
<p>当你运行这行代码时，Linux 用户空间（User Space）和内核空间（Kernel Space）发生了一次交互：</p>
<ol>
<li><p><strong>打开驱动文件</strong>：</p>
<ul>
<li><p>OP-TEE 在 Linux 中是一个驱动设备，通常位于 <code>/dev/tee0</code>。</p>
</li>
<li><p><code>TEEC_InitializeContext</code> 的内部实现，实际上是在调用 Linux 的 <code>open(&quot;/dev/tee0&quot;, ...)</code> 系统调用。</p>
</li>
</ul>
</li>
<li><p><strong>建立连接</strong>：</p>
<ul>
<li>如果 <code>/dev/tee0</code> 打开成功，Linux 内核里的 OP-TEE 驱动就会记录下：“嘿，有一个新的应用程序（你的 CA）连上来了。”</li>
</ul>
</li>
<li><p><strong>保存句柄</strong>：</p>
<ul>
<li><p><code>open</code> 函数会返回一个<strong>文件描述符 (File Descriptor, fd)</strong>。</p>
</li>
<li><p>这个 <code>fd</code> 会被悄悄地保存在 <code>ctx</code> 结构体的内部成员里（通常叫 <code>ctx-&gt;fd</code>）。</p>
</li>
<li><p>以后你调用 <code>TEEC_OpenSession</code> 时，库函数会直接去 <code>ctx</code> 里找这个 <code>fd</code>，通过它和内核说话。</p>
</li>
</ul>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p><strong>做什么</strong>：建立 CA 和 Linux TEE 驱动之间的通路。</p>
</li>
<li><p><strong>输入 <code>NULL</code></strong>：选默认的 TEE。</p>
</li>
<li><p><strong>输入 <code>&amp;ctx</code></strong>：给个空篮子，让函数把“连接句柄”放进去。</p>
</li>
<li><p><strong>底层</strong>：本质上就是 <code>open(&quot;/dev/tee0&quot;)</code>。</p>
</li>
</ul>
<h3 id="第二步：开启会话"><a href="#第二步：开启会话" class="headerlink" title="第二步：开启会话"></a><strong>第二步：开启会话</strong></h3><h3 id="1-代码再现"><a href="#1-代码再现" class="headerlink" title="1. 代码再现"></a>1. 代码再现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">TEEC_UUID uuid = TA_HELLO_WORLD_UUID; <span class="hljs-comment">// 1. 准备好 TA 的身份证号</span><br><br><span class="hljs-comment">/* 2. 发起会话连接 */</span><br>res = TEEC_OpenSession(&amp;ctx, &amp;sess, &amp;uuid,<br>                       TEEC_LOGIN_PUBLIC, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;err_origin);<br></code></pre></td></tr></table></figure>

<h3 id="2-参数拆解：这一行代码到底传了什么？"><a href="#2-参数拆解：这一行代码到底传了什么？" class="headerlink" title="2. 参数拆解：这一行代码到底传了什么？"></a>2. 参数拆解：这一行代码到底传了什么？</h3><p>这个函数参数有点多，但我们只需要关注其中 4 个核心参数：</p>
<h4 id="A-ctx-Context"><a href="#A-ctx-Context" class="headerlink" title="A. &amp;ctx (Context)"></a>A. <code>&amp;ctx</code> (Context)</h4><ul>
<li><p><strong>含义</strong>：你刚才在第一步拿到的“大厅通行证”。</p>
</li>
<li><p><strong>作用</strong>：告诉系统，“我是通过哪条线路进来的”。（底层就是用那个 <code>fd</code>）。</p>
</li>
</ul>
<h4 id="B-uuid-Destination"><a href="#B-uuid-Destination" class="headerlink" title="B. &amp;uuid (Destination)"></a>B. <code>&amp;uuid</code> (Destination)</h4><ul>
<li><p><strong>含义</strong>：<strong>我要找谁？</strong></p>
</li>
<li><p><strong>作用</strong>：这是我们在头文件里定义的那个长长的 16 进制数组。</p>
</li>
<li><p><strong>比喻</strong>：你在大厅里喊：“请问 <strong>8aaaf200…</strong> 号业务员在吗？”</p>
<ul>
<li>OP-TEE OS 收到请求后，会去查它的存储区域，找到文件名叫 <code>8aaaf200...ta</code> 的文件，把它加载进内存。</li>
</ul>
</li>
</ul>
<h4 id="C-sess-Session-——-新的主角"><a href="#C-sess-Session-——-新的主角" class="headerlink" title="C. &amp;sess (Session) —— 新的主角"></a>C. <code>&amp;sess</code> (Session) —— <strong>新的主角</strong></h4><ul>
<li><p><strong>含义</strong>：<strong>会话句柄</strong>（这也是一个“传出参数”）。</p>
</li>
<li><p><strong>作用</strong>：一旦连接成功，库函数会把这次“专线连接”的信息填在这个结构体里。</p>
</li>
<li><p><strong>重要区别</strong>：</p>
<ul>
<li><p><code>ctx</code> 是你和<strong>整个 TEE 系统</strong>的连接。</p>
</li>
<li><p><code>sess</code> 是你和<strong>这个特定 TA</strong> 的私聊通道。</p>
</li>
<li><p><em>以后发指令（InvokeCommand），用的是 <code>sess</code>，不再是 <code>ctx</code> 了。</em></p>
</li>
</ul>
</li>
</ul>
<h4 id="D-TEEC-LOGIN-PUBLIC-Connection-Method"><a href="#D-TEEC-LOGIN-PUBLIC-Connection-Method" class="headerlink" title="D. TEEC_LOGIN_PUBLIC (Connection Method)"></a>D. <code>TEEC_LOGIN_PUBLIC</code> (Connection Method)</h4><ul>
<li><p><strong>含义</strong>：<strong>我凭什么身份找你？</strong></p>
</li>
<li><p><strong>解释</strong>：这是 OP-TEE 的权限控制机制。</p>
<ul>
<li><p><code>TEEC_LOGIN_PUBLIC</code>：意思是“我是公众用户，我没啥特权，我就想办个普通业务”。这是最常用的，也是 <code>hello_world</code> 用的。</p>
</li>
<li><p><em>进阶知识</em>：如果 TA 处理的是高度敏感数据（比如指纹），它可能要求你提供 <code>TEEC_LOGIN_USER</code>（通过 Linux 用户 ID 验证），只有特定用户组的 Linux 进程才能连上它。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-墙的另一边发生了什么？（关键）"><a href="#3-墙的另一边发生了什么？（关键）" class="headerlink" title="3. 墙的另一边发生了什么？（关键）"></a>3. 墙的另一边发生了什么？（关键）</h3><p>当你调用 <code>TEEC_OpenSession</code> 时，世界线发生了一次<strong>巨大的跳跃</strong>。</p>
<ol>
<li><p><strong>加载 (Loading)</strong>： OP-TEE OS 检查内存里有没有这个 TA。如果没有，它会从文件系统里把 TA 的二进制代码（<code>.ta</code> 文件）读出来，校验签名（确保没被篡改），然后运行它。</p>
</li>
<li><p><strong>握手 (Handshake)</strong>： TA 启动后，OP-TEE OS 会立刻调用 TA 里的一个回调函数： <strong><code>TA_OpenSessionEntryPoint</code></strong></p>
<ul>
<li><p><strong>如果 TA 代码里写了</strong>：“拒绝 Public 身份的用户连接”。</p>
<ul>
<li>那么 <code>TEEC_OpenSession</code> 会返回失败（Access Denied）。</li>
</ul>
</li>
<li><p><strong>如果 TA 代码里写了</strong>：“欢迎光临”。</p>
<ul>
<li>那么 <code>TEEC_OpenSession</code> 返回 <code>TEEC_SUCCESS</code>。</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-那个-err-origin-是干嘛的？"><a href="#4-那个-err-origin-是干嘛的？" class="headerlink" title="4. 那个 err_origin 是干嘛的？"></a>4. 那个 <code>err_origin</code> 是干嘛的？</h3><p>你可能注意到了最后一个参数 <code>&amp;err_origin</code>。这玩意儿非常实用，它是用来<strong>甩锅</strong>的。</p>
<p>如果 <code>TEEC_OpenSession</code> 返回了失败（比如返回了 0xFFFF），你怎么知道是谁的问题？</p>
<ul>
<li><p>如果 <code>err_origin == TEEC_ORIGIN_API</code>：</p>
<ul>
<li><strong>你的问题</strong>。比如你传了个空指针，或者驱动没装好。</li>
</ul>
</li>
<li><p>如果 <code>err_origin == TEEC_ORIGIN_TEE</code>：</p>
<ul>
<li><strong>OP-TEE OS 的问题</strong>。比如系统内存不足了，或者找不到那个 UUID 的文件。</li>
</ul>
</li>
<li><p>如果 <code>err_origin == TEEC_ORIGIN_TRUSTED_APP</code>：</p>
<ul>
<li><strong>TA 的问题</strong>。系统帮你找到了 TA，但是 TA 的 <code>TA_OpenSessionEntryPoint</code> 函数里返回了错误（比如它不喜欢你的脸）。</li>
</ul>
</li>
</ul>
<h3 id="第三步：发送请求"><a href="#第三步：发送请求" class="headerlink" title="第三步：发送请求"></a><strong>第三步：发送请求</strong></h3><p>第三步是整个流程的高潮：<strong>业务办理（发送指令 &amp; 数据交互）</strong>。</p>
<p>如果说前两步只是“进大厅”和“坐到柜台前”，那么这一步就是你真正<strong>把填好的单子递进去</strong>，并看着柜员盖章签字的过程。</p>
<p>在代码中，这一步分为两个子动作：<strong>“填单子”</strong> (<code>TEEC_Operation</code>) 和 <strong>“递单子”</strong> (<code>TEEC_InvokeCommand</code>)。</p>
<hr>
<h3 id="子动作-A：填单子-TEEC-Operation"><a href="#子动作-A：填单子-TEEC-Operation" class="headerlink" title="子动作 A：填单子 (TEEC_Operation)"></a>子动作 A：填单子 (<code>TEEC_Operation</code>)</h3><p>OP-TEE 设计了一个非常严格的规则：你不能随便往里扔一堆烂数据。你必须把数据整理进一个叫 <code>TEEC_Operation</code> 的结构体里。</p>
<p>你可以把它想象成银行柜台的一个<strong>有 4 个凹槽的托盘</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">TEEC_Operation op;<br><span class="hljs-comment">/* 1. 清空托盘 (非常重要，防止里面有垃圾数据) */</span><br><span class="hljs-built_in">memset</span>(&amp;op, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(op));<br><br><span class="hljs-comment">/* 2. 定义凹槽的用途 */</span><br>op.paramTypes = TEEC_PARAM_TYPES(TEEC_VALUE_INOUT, TEEC_NONE, TEEC_NONE, TEEC_NONE);<br><br><span class="hljs-comment">/* 3. 放入数据 */</span><br>op.params[<span class="hljs-number">0</span>].value.a = <span class="hljs-number">42</span>;<br></code></pre></td></tr></table></figure>

<h4 id="关键点解析："><a href="#关键点解析：" class="headerlink" title="关键点解析："></a>关键点解析：</h4><ol>
<li><p><strong><code>TEEC_PARAM_TYPES</code> (贴标签)</strong></p>
<ul>
<li><p>OP-TEE 规定这个托盘<strong>最多只能放 4 个参数</strong>（param0 ~ param3）。</p>
</li>
<li><p>你必须显式地告诉 TA，每个凹槽里放的是什么类型的数据。</p>
</li>
<li><p><strong><code>TEEC_VALUE_INOUT</code></strong>：这是最关键的标签。</p>
<ul>
<li><p><strong>VALUE</strong>：表示我要传的是简单的<strong>整数</strong>（不是指针&#x2F;内存块）。</p>
</li>
<li><p><strong>INOUT</strong>：表示这个数据是<strong>双向</strong>的。“我传进去（IN）给 TA 看，TA 改完后再传出来（OUT）给我看”。</p>
</li>
</ul>
</li>
<li><p><strong><code>TEEC_NONE</code></strong>：表示这个凹槽我不用，空着。</p>
</li>
</ul>
</li>
<li><p><strong><code>op.params[0].value.a</code> (放数据)</strong></p>
<ul>
<li><p>对应上面的标签，我们在第 0 个凹槽 (<code>params[0]</code>) 里放数据。</p>
</li>
<li><p><strong>为什么是 <code>.value.a</code>？</strong></p>
<ul>
<li><p>因为 <code>TEEC_Value</code> 类型可以容纳两个整数，分别叫 <code>a</code> 和 <code>b</code>。</p>
</li>
<li><p>你可以只用 <code>a</code>，也可以 <code>a</code> 和 <code>b</code> 都用（比如传坐标 x,y 时就很有用）。</p>
</li>
</ul>
</li>
<li><p>这里我们把 <strong>42</strong> 放进了 <code>a</code> 里。</p>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="子动作-B：递单子-TEEC-InvokeCommand"><a href="#子动作-B：递单子-TEEC-InvokeCommand" class="headerlink" title="子动作 B：递单子 (TEEC_InvokeCommand)"></a>子动作 B：递单子 (<code>TEEC_InvokeCommand</code>)</h3><p>单子填好了，现在要按下按钮，把它传送进去。</p>
<p>C</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-comment">/* TA_HELLO_WORLD_CMD_INC_VALUE 是具体的指令代码，比如定义为 0 */</span><br><span class="hljs-attr">res</span> <span class="hljs-operator">=</span> TEEC_InvokeCommand(<span class="hljs-variable">&amp;sess</span>, TA_HELLO_WORLD_CMD_INC_VALUE, <span class="hljs-variable">&amp;op</span>, <span class="hljs-variable">&amp;err_origin</span>)<span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure>

<h4 id="参数拆解："><a href="#参数拆解：" class="headerlink" title="参数拆解："></a>参数拆解：</h4><ol>
<li><p><strong><code>&amp;sess</code></strong>：</p>
<ul>
<li><p>使用你在第二步建立的那个<strong>专属会话</strong>。</p>
</li>
<li><p>这确保了指令是发给“Hello World TA”的，而不是隔壁的“加密 TA”。</p>
</li>
</ul>
</li>
<li><p><strong><code>TA_HELLO_WORLD_CMD_INC_VALUE</code> (Command ID)</strong>：</p>
<ul>
<li><p>这是你对柜员喊出的<strong>具体业务名</strong>：“我要办<strong>加法</strong>业务！”</p>
</li>
<li><p>TA 那边会有一个大的 <code>switch-case</code> 语句，根据这个 ID 跳转到对应的加法函数。</p>
</li>
</ul>
</li>
<li><p><strong><code>&amp;op</code></strong>：</p>
<ul>
<li>把刚才填好的托盘递进去。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="⚠️-数据流动的全过程（穿越时刻）"><a href="#⚠️-数据流动的全过程（穿越时刻）" class="headerlink" title="⚠️ 数据流动的全过程（穿越时刻）"></a>⚠️ 数据流动的全过程（穿越时刻）</h3><p>这是最神奇的地方。当你执行这就话时，CPU 的状态发生了如下变化：</p>
<ol>
<li><p><strong>CA 暂停 (Blocking)</strong>：</p>
<ul>
<li>你的 <code>main.c</code> 程序在这里<strong>卡住不动了</strong>。它在等待结果。</li>
</ul>
</li>
<li><p><strong>世界切换 (Context Switch)</strong>：</p>
<ul>
<li><p>Linux 内核通过驱动发起 SMC (Secure Monitor Call) 指令。</p>
</li>
<li><p>CPU 从 <strong>Normal World (Linux)</strong> 切换进 <strong>Secure World (OP-TEE)</strong>。</p>
</li>
</ul>
</li>
<li><p><strong>TA 接单</strong>：</p>
<ul>
<li><p>OP-TEE OS 唤醒 TA，调用 TA 的 <code>TA_InvokeCommandEntryPoint</code>。</p>
</li>
<li><p>TA 读取 <code>params[0].value.a</code> (也就是 42)。</p>
</li>
<li><p>TA 执行逻辑：<code>val = 42 + 1;</code></p>
</li>
<li><p>TA <strong>修改托盘里的数据</strong>：<code>params[0].value.a = 43;</code></p>
</li>
<li><p>TA 返回 <code>TEE_SUCCESS</code>。</p>
</li>
</ul>
</li>
<li><p><strong>CA 恢复</strong>：</p>
<ul>
<li><p>CPU 切回 Linux。</p>
</li>
<li><p><code>TEEC_InvokeCommand</code> 函数返回。</p>
</li>
<li><p>你的程序继续往下走。</p>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TA incremented value to %d\n&quot;</span>, op.params[<span class="hljs-number">0</span>].value.a);<br></code></pre></td></tr></table></figure>

<p>此时你去读内存里的 <code>op</code> 结构体，你会发现刚才填进去的 42 已经被<strong>原地篡改</strong>成了 43。</p>
<p>这就是 <strong>INOUT（双向传递）</strong> 的魔力。</p>
<h3 id="总结第三步"><a href="#总结第三步" class="headerlink" title="总结第三步"></a>总结第三步</h3><ul>
<li><p><strong>工具</strong>：<code>TEEC_Operation</code> 是唯一合法的数据载体（托盘）。</p>
</li>
<li><p><strong>动作</strong>：<code>TEEC_InvokeCommand</code> 是穿越世界的触发器。</p>
</li>
<li><p><strong>效果</strong>：数据进去转了一圈，被 TA 修改后又送了回来。</p>
</li>
</ul>
<p>至此，CA 端（Linux 端）的代码逻辑你已经全部打通了！</p>
<h3 id="第四步：关闭会话，销毁环境"><a href="#第四步：关闭会话，销毁环境" class="headerlink" title="第四步：关闭会话，销毁环境"></a><strong>第四步：关闭会话，销毁环境</strong></h3><h3 id="1-TEEC-CloseSession-sess"><a href="#1-TEEC-CloseSession-sess" class="headerlink" title="1. TEEC_CloseSession(&amp;sess)"></a>1. <code>TEEC_CloseSession(&amp;sess)</code></h3><p><strong>对应步骤</strong>：<code>TEEC_OpenSession</code> <strong>比喻</strong>：办完业务了，<strong>离开柜台</strong>。</p>
<ul>
<li><p><strong>它的作用</strong>： 告诉 OP-TEE：“我和这个 TA (Hello World) 的这次对话结束了。”</p>
</li>
<li><p><strong>发生了什么？（连锁反应）</strong></p>
<ol>
<li><p><strong>CA 端</strong>：标记 <code>sess</code> 结构体失效，你不能再用它发指令了。</p>
</li>
<li><p><strong>穿越世界</strong>：系统发送信号给 Secure World。</p>
</li>
<li><p><strong>TA 端（关键）</strong>：</p>
<ul>
<li><p>OP-TEE OS 会调用 TA 里的回调函数 <strong><code>TA_CloseSessionEntryPoint</code></strong>。</p>
</li>
<li><p><strong>这一步非常重要！</strong> 假如 TA 在为你服务的过程中申请了堆内存（malloc），它必须在这个回调函数里释放掉。如果你不调用 <code>CloseSession</code>，TA 那边的内存可能就一直被占着，变成**“僵尸内存”**。</p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr>
<h3 id="2-TEEC-FinalizeContext-ctx"><a href="#2-TEEC-FinalizeContext-ctx" class="headerlink" title="2. TEEC_FinalizeContext(&amp;ctx)"></a>2. <code>TEEC_FinalizeContext(&amp;ctx)</code></h3><p><strong>对应步骤</strong>：<code>TEEC_InitializeContext</code> <strong>比喻</strong>：把通行证还给大堂经理，<strong>走出银行大门</strong>。</p>
<ul>
<li><p><strong>它的作用</strong>： 彻底断开你的应用程序 (CA) 与 OP-TEE 驱动之间的连接。</p>
</li>
<li><p><strong>发生了什么？</strong></p>
<ol>
<li><p><strong>销毁资源</strong>：它会释放 <code>ctx</code> 结构体里分配的内存。</p>
</li>
<li><p><strong>关闭文件</strong>：</p>
<ul>
<li><p>还记得我们之前说的 <code>fd</code> (文件描述符) 吗？</p>
</li>
<li><p>这个函数底层会执行 <code>close(ctx-&gt;fd)</code>。</p>
</li>
<li><p>这等于挂断了通往内核驱动的电话线。</p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr>
<h3 id="为什么要这么繁琐？（资源泄漏的后果）"><a href="#为什么要这么繁琐？（资源泄漏的后果）" class="headerlink" title="为什么要这么繁琐？（资源泄漏的后果）"></a>为什么要这么繁琐？（资源泄漏的后果）</h3><p>想象一下，如果你写了一个 App，要在后台一直运行（比如指纹服务），并且你每次用完都不关 Session：</p>
<ol>
<li><p>你申请了 Session 1，占用了一点 TEE 内存。</p>
</li>
<li><p>你申请了 Session 2，又占用了一点。</p>
</li>
<li><p>…</p>
</li>
<li><p><strong>崩溃</strong>：OP-TEE 的内存是非常有限的（通常只有几 MB 到几十 MB）。很快，OP-TEE 就会报 <code>TEE_ERROR_OUT_OF_MEMORY</code>，导致整个安全功能瘫痪，甚至可能导致系统重启。</p>
</li>
</ol>
<h3 id="总结-CA-端的“四部曲”"><a href="#总结-CA-端的“四部曲”" class="headerlink" title="总结 CA 端的“四部曲”"></a>总结 CA 端的“四部曲”</h3><p>到现在为止，你已经完整复盘了 CA (Host) 端的生命周期：</p>
<ol>
<li><p><strong>Initialize</strong>: 进门（拿 fd）。</p>
</li>
<li><p><strong>OpenSession</strong>: 找人（连 UUID，触发 TA 的 <code>OpenSession</code>）。</p>
</li>
<li><p><strong>InvokeCommand</strong>: 办事（传 INOUT 参数，触发 TA 的 <code>InvokeCommand</code>）。</p>
</li>
<li><p><strong>Close &amp; Finalize</strong>: 走人（触发 TA 的 <code>CloseSession</code>，释放 fd）。</p>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF%E7%A0%94%E7%A9%B6/" class="category-chain-item">技术研究</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OPTEE/" class="print-no-link">#OPTEE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CA快速入门</div>
      <div>https://jakechender.github.io/2025/11/25/1、CA快速入门/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Haoyu Chai</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年11月25日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/25/2%E3%80%81TA%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="TA快速入门">
                        <span class="hidden-mobile">TA快速入门</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div>Copyright © 2025 HY-Chai</div> <div style="font-size: 0.85rem"> <span>Powered by </span> <a href="https://hexo.io" target="_blank" rel="nofollow noopener">Hexo</a> <span> & </span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">Fluid</a> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/slogan-loop.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
